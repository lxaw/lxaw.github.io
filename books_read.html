<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading List | Lex Whalen</title>
    <style>
        :root{
            --text:#111;
            --muted: rgba(0,0,0,.62);
            --hair: rgba(0,0,0,.10);
            --hair-2: rgba(0,0,0,.06);
        }

        body{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            max-width: 980px;
            margin: 40px auto;
            padding: 0 20px;
            line-height: 1.55;
            color: var(--text);
        }

        a{ color: var(--text); text-decoration: none; }
        a:hover{ text-decoration: underline; }

        .intro p{ margin: 6px 0; }
        .muted{ color: var(--muted); }

        /* Controls */
        .controls{
            margin: 18px 0 6px 0;
            padding: 10px 0 0 0;
            border-top: 1px solid var(--hair);
        }

        .counts{
            margin: 10px 0 14px 0;
        }
        #bookCount{
            font-weight: 600;
            font-size: 14px;
            margin: 0;
        }
        #searchCount{
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--muted);
        }

        .search-row{
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 10px 0 10px 0;
        }

        .search-row input{
            flex: 1;
            min-width: 240px;
            padding: 10px 10px;
            border: 1px solid var(--hair);
            border-radius: 10px;
            outline: none;
            font-size: 14px;
            background: transparent;
        }
        .search-row input:focus{
            border-color: rgba(0,0,0,.25);
        }

        .btn{
            border: 1px solid var(--hair);
            background: transparent;
            padding: 9px 10px;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text);
        }
        .btn:hover{
            border-color: rgba(0,0,0,.25);
        }

        /* Advanced filters: hidden by default */
        #advancedFilters{
            display: none;
            gap: 12px;
            margin: 10px 0 0 0;
            flex-wrap: wrap;
            align-items: center;
            padding: 10px 0 2px 0;
        }
        #advancedFilters.show{ display: flex; }

        #advancedFilters label{
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--muted);
        }

        #advancedFilters input[type="number"]{
            width: 90px;
            padding: 8px 8px;
            border: 1px solid var(--hair);
            border-radius: 10px;
            background: transparent;
            color: var(--text);
            outline: none;
        }
        #advancedFilters input[type="number"]:focus{
            border-color: rgba(0,0,0,.25);
        }
        #advancedFilters input[type="checkbox"]{
            transform: translateY(1px);
        }

        /* Table */
        table{
            width: 100%;
            border-collapse: collapse;
            margin-top: 14px;
            font-size: 14px;
        }
        thead th{
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--muted);
            padding: 10px 8px;
            border-bottom: 1px solid var(--hair);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        thead th:hover{
            color: var(--text);
        }

        tbody td{
            padding: 12px 8px;
            border-bottom: 1px solid var(--hair-2);
            vertical-align: top;
        }

        /* Keep description readable */
        td.desc{
            color: rgba(0,0,0,.78);
        }

        /* Slightly tighter on small screens */
        @media (max-width: 720px){
            body{ margin: 24px auto; }
            .search-row input{ min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="intro">
        <p>This list was curated by <a href="index.html">myself</a>, beginning from around February 2023 to now.</p>
        <p class="muted">I typically use this to organize books I found interesting. Please feel free to do whatever you want with it.</p>
    </div>

    <div class="controls">
        <div class="counts">
            <p id="bookCount">So far, we have read XXX books. Let's keep it up!</p>
            <small id="searchCount"></small>
        </div>

        <!-- Minimal search row -->
        <div class="search-row">
            <!-- Keep your individual fields, but make them minimal. If you want ONE search box only, tell me and I’ll simplify the JS. -->
            <input type="text" id="titleSearch" placeholder="Title" onkeyup="applyFilters()">
            <input type="text" id="authorSearch" placeholder="Author" onkeyup="applyFilters()">
            <input type="text" id="yearSearch" placeholder="Year" onkeyup="applyFilters()">
            <input type="text" id="descriptionSearch" placeholder="Description" onkeyup="applyFilters()">

            <button class="btn" type="button" onclick="toggleFilters()">Filters</button>
            <button class="btn" type="button" onclick="clearAllFilters()">Clear</button>
        </div>

        <!-- Advanced filters -->
        <div id="advancedFilters">
            <label>Min pages <input type="number" id="minPages" placeholder="0" onchange="applyFilters()"></label>
            <label>Max pages <input type="number" id="maxPages" placeholder="∞" onchange="applyFilters()"></label>

            <label>From <input type="number" id="yearFrom" placeholder="2023" min="1900" max="2100" onchange="applyFilters()"></label>
            <label>To <input type="number" id="yearTo" placeholder="2026" min="1900" max="2100" onchange="applyFilters()"></label>

            <label><input type="checkbox" id="exactMatch" onchange="applyFilters()"> exact</label>
            <label><input type="checkbox" id="caseSensitive" onchange="applyFilters()"> case</label>
        </div>
    </div>

    <table id="bookTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Title</th>
                <th onclick="sortTable(1)">Author</th>
                <th onclick="sortTable(2)">Date</th>
                <th onclick="sortTable(3)">Pages</th>
                <th onclick="sortTable(4)">Rating</th>
                <th onclick="sortTable(5)">Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6">Loading books...</td></tr>
        </tbody>
    </table>

    <script>
        let allBooks = [];
        let filteredBooks = [];
        let sortDirection = {};

        fetch('books/list.json')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load books');
                return response.json();
            })
            .then(books => {
                allBooks = books;
                filteredBooks = [...allBooks];
                displayBooks(filteredBooks);
                updateCounts();
            })
            .catch(error => {
                console.error('Error loading books:', error);
                document.querySelector('#bookTable tbody').innerHTML =
                    '<tr><td colspan="6">Error loading books. Please try again later.</td></tr>';
            });

        function displayBooks(books) {
            const tbody = document.querySelector('#bookTable tbody');
            tbody.innerHTML = '';

            if (books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No books found.</td></tr>';
                return;
            }

            books.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${book.title || ''}</td>
                    <td>${book.author || ''}</td>
                    <td>${book['date-complete'] || ''}</td>
                    <td>${book['page-count'] || ''}</td>
                    <td>${book.rating || ''}</td>
                    <td class="desc">${book.description || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyFilters() {
            const titleSearch = document.getElementById('titleSearch').value;
            const authorSearch = document.getElementById('authorSearch').value;
            const yearSearch = document.getElementById('yearSearch').value;
            const descriptionSearch = document.getElementById('descriptionSearch').value;
            const minPages = document.getElementById('minPages').value;
            const maxPages = document.getElementById('maxPages').value;
            const yearFrom = document.getElementById('yearFrom').value;
            const yearTo = document.getElementById('yearTo').value;
            const exactMatch = document.getElementById('exactMatch').checked;
            const caseSensitive = document.getElementById('caseSensitive').checked;

            filteredBooks = allBooks.filter(book => {
                const matchText = (text, searchTerm) => {
                    if (!searchTerm) return true;
                    if (!text) return false;

                    const textToSearch = caseSensitive ? text : text.toLowerCase();
                    const termToSearch = caseSensitive ? searchTerm : searchTerm.toLowerCase();

                    return exactMatch ? textToSearch === termToSearch : textToSearch.includes(termToSearch);
                };

                if (!matchText(book.title, titleSearch)) return false;
                if (!matchText(book.author, authorSearch)) return false;
                if (!matchText(book.description, descriptionSearch)) return false;

                if (yearSearch) {
                    const dateText = book['date-complete'] || '';
                    if (!matchText(dateText, yearSearch)) return false;
                }

                if (minPages || maxPages) {
                    const pageCount = parseInt(book['page-count']) || 0;
                    if (minPages && pageCount < parseInt(minPages)) return false;
                    if (maxPages && pageCount > parseInt(maxPages)) return false;
                }

                if (yearFrom || yearTo) {
                    const bookYear = book['date-complete'] ? new Date(book['date-complete']).getFullYear() : 0;
                    if (yearFrom && bookYear < parseInt(yearFrom)) return false;
                    if (yearTo && bookYear > parseInt(yearTo)) return false;
                }

                return true;
            });

            displayBooks(filteredBooks);
            updateCounts();
        }

        function clearAllFilters() {
            document.getElementById('titleSearch').value = '';
            document.getElementById('authorSearch').value = '';
            document.getElementById('yearSearch').value = '';
            document.getElementById('descriptionSearch').value = '';
            document.getElementById('minPages').value = '';
            document.getElementById('maxPages').value = '';
            document.getElementById('yearFrom').value = '';
            document.getElementById('yearTo').value = '';
            document.getElementById('exactMatch').checked = false;
            document.getElementById('caseSensitive').checked = false;

            filteredBooks = [...allBooks];
            displayBooks(filteredBooks);
            updateCounts();
        }

        function updateCounts() {
            const totalBooks = allBooks.length;
            const displayedBooks = filteredBooks.length;

            const displayedPages = filteredBooks.reduce((sum, book) => {
                const pages = parseInt(book['page-count']) || 0;
                return sum + pages;
            }, 0);

            document.getElementById('bookCount').textContent =
                `So far, we have read ${totalBooks} books.`;

            if (displayedBooks === totalBooks) {
                document.getElementById('searchCount').textContent = '';
            } else {
                document.getElementById('searchCount').textContent =
                    `${displayedBooks} shown (${displayedPages.toLocaleString()} pages).`;
            }
        }

        function sortTable(columnIndex) {
            const isAsc = sortDirection[columnIndex] !== 'asc';
            sortDirection[columnIndex] = isAsc ? 'asc' : 'desc';

            const columnMap = ['title', 'author', 'date-complete', 'page-count', 'rating', 'description'];
            const sortKey = columnMap[columnIndex];

            filteredBooks.sort((a, b) => {
                let aValue = a[sortKey] || '';
                let bValue = b[sortKey] || '';

                if (columnIndex === 3) { // pages
                    aValue = parseInt(aValue) || 0;
                    bValue = parseInt(bValue) || 0;
                    return isAsc ? aValue - bValue : bValue - aValue;
                }

                if (columnIndex === 2) { // date
                    aValue = new Date(aValue || 0);
                    bValue = new Date(bValue || 0);
                    return isAsc ? aValue - bValue : bValue - aValue;
                }

                if (columnIndex === 4) { // rating
                    aValue = aValue ? parseInt(aValue.split('/')[0]) : 0;
                    bValue = bValue ? parseInt(bValue.split('/')[0]) : 0;
                    return isAsc ? aValue - bValue : bValue - aValue;
                }

                return isAsc
                    ? aValue.toString().localeCompare(bValue.toString())
                    : bValue.toString().localeCompare(aValue.toString());
            });

            displayBooks(filteredBooks);
        }

        function toggleFilters(){
            document.getElementById('advancedFilters').classList.toggle('show');
        }

        function searchBooks() { applyFilters(); } // legacy
    </script>
</body>
</html>